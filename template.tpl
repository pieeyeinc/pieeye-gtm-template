___INFO___

{
  "type": "TAG",
  "id": "cvt_temp_public_id",
  "version": 1,
  "securityGroups": [],
  "displayName": "PieEye Consent Mode",
  "brand": {
    "id": "brand_dummy",
    "displayName": "",
    "thumbnail": "data:image/png;base64,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\u003d\u003d"
  },
  "description": "PieEye Consent Mode simplifies the process of gathering consent from your website visitors, helping you achieve compliance with GDPR and CCPA regulations. Learn more at pii.ai Support: support@pii.ai",
  "containerContexts": [
    "WEB"
  ]
}


___TEMPLATE_PARAMETERS___

[
  {
    "type": "GROUP",
    "name": "defaultSettings",
    "displayName": "Default Consent Settings",
    "groupStyle": "NO_ZIPPY",
    "subParams": [
      {
        "type": "PARAM_TABLE",
        "name": "settingsTable",
        "displayName": "Add Setting",
        "paramTableColumns": [
          {
            "param": {
              "type": "SELECT",
              "name": "ad_storage",
              "displayName": "Advertising",
              "macrosInSelect": false,
              "selectItems": [
                {
                  "value": "granted",
                  "displayValue": "Granted"
                },
                {
                  "value": "denied",
                  "displayValue": "Denied"
                }
              ],
              "simpleValueType": true,
              "defaultValue": "denied",
              "help": "Select default consent state for advertising cookies"
            },
            "isUnique": false
          },
          {
            "param": {
              "type": "SELECT",
              "name": "analytics_storage",
              "displayName": "Analytics",
              "macrosInSelect": false,
              "selectItems": [
                {
                  "value": "granted",
                  "displayValue": "Granted"
                },
                {
                  "value": "denied",
                  "displayValue": "Denied"
                }
              ],
              "simpleValueType": true,
              "defaultValue": "denied",
              "help": "Select default consent state for analytics cookies"
            },
            "isUnique": false
          },
          {
            "param": {
              "type": "SELECT",
              "name": "personalization_storage",
              "displayName": "Personalization",
              "macrosInSelect": false,
              "selectItems": [
                {
                  "value": "granted",
                  "displayValue": "Granted"
                },
                {
                  "value": "denied",
                  "displayValue": "Denied"
                }
              ],
              "simpleValueType": true,
              "defaultValue": "denied",
              "help": "Select default consent state for personalization cookies"
            },
            "isUnique": false
          },
          {
            "param": {
              "type": "SELECT",
              "name": "functionality_storage",
              "displayName": "Functionality",
              "macrosInSelect": false,
              "selectItems": [
                {
                  "value": "granted",
                  "displayValue": "Granted"
                },
                {
                  "value": "denied",
                  "displayValue": "Denied"
                }
              ],
              "simpleValueType": true,
              "defaultValue": "denied",
              "help": "Select default consent state for functionality cookies"
            },
            "isUnique": false
          },
          {
            "param": {
              "type": "SELECT",
              "name": "security_storage",
              "displayName": "Security",
              "macrosInSelect": false,
              "selectItems": [
                {
                  "value": "granted",
                  "displayValue": "Granted"
                },
                {
                  "value": "denied",
                  "displayValue": "Denied"
                }
              ],
              "simpleValueType": true,
              "defaultValue": "denied",
              "help": "Select default consent state for security cookies"
            },
            "isUnique": false
          },
          {
            "param": {
              "type": "TEXT",
              "name": "wait_for_update",
              "displayName": "Wait for Update",
              "simpleValueType": true,
              "defaultValue": 200,
              "help": "Set the waiting time in milliseconds before triggering tags that require consent."
            },
            "isUnique": false
          },
          {
            "param": {
              "type": "TEXT",
              "name": "region",
              "displayName": "Region",
              "simpleValueType": true
            },
            "isUnique": false
          }
        ],
        "alwaysInSummary": false,
        "clearOnCopy": false,
        "notSetText": "",
        "newRowTitle": "Add Setting",
        "editRowTitle": "Edit Setting"
      }
    ]
  },
  {
    "type": "GROUP",
    "name": "other",
    "displayName": "Other Settings",
    "groupStyle": "ZIPPY_OPEN",
    "subParams": [
      {
        "type": "CHECKBOX",
        "name": "url_passthrough",
        "checkboxText": "Pass Ad Click Information Through URLs",
        "simpleValueType": true,
        "help": "When using URL passthrough, a few query parameters may be appended to links as users navigate through pages on your website"
      },
      {
        "type": "CHECKBOX",
        "name": "ads_data_redaction",
        "checkboxText": "Redact Ads Data",
        "simpleValueType": true,
        "help": "Select this option if you want internal links to retain advertising identifiers in their URLs until consent is given."
      }
    ]
  }
]


___SANDBOXED_JS_FOR_WEB_TEMPLATE___

const gtagSet = require('gtagSet');
const setDefaultConsentState = require('setDefaultConsentState');
const getCookieValues = require('getCookieValues');
const updateConsentState = require('updateConsentState');
const JSON = require('JSON');
const log = require('logToConsole');

const consentFlag = getCookieValues("consentGiven")[0] ? true : false;
log(consentFlag);

// Process default consent state
if(!consentFlag){
  // Set advanced settings
  gtagSet({
    url_passthrough: data.url_passthrough || false,
    ads_data_redaction: data.ads_data_redaction || false
  });
  
  const getRegionArr = (regionStr) => {
        return regionStr.split(',')
            .map(region => region.trim())
            .filter(region => region.length !== 0);
    };
  
  data.settingsTable.forEach(setting => {
    
    const waitTime = setting.wait_for_update === '' ? '0' : setting.wait_for_update;
    const settingObject = {
      ad_storage: setting.ad_storage,
      analytics_storage: setting.analytics_storage,
      personalization_storage: setting.personalization_storage,
      functionality_storage: setting.functionality_storage,
      security_storage: setting.security_storage,
      wait_for_update: waitTime
    };
    
    const regionArr = getRegionArr(setting.region);
    if (regionArr.length) {
          settingObject.region = regionArr;
        }
    
    log('default consent from template');
    setDefaultConsentState(settingObject);
  });
}else{
  log('update consent from template');
  const settingObject = JSON.parse(getCookieValues("consentGiven")[0]);
  updateConsentState(settingObject);

  // Set advanced settings
  const consentAdvanceSetting = JSON.parse(getCookieValues("consentAdvanceSetting")[0]);
  if(consentAdvanceSetting){
    gtagSet(
     consentAdvanceSetting
    );
  }
}

// Call data.gtmOnSuccess when the tag is finished.
data.gtmOnSuccess();


___WEB_PERMISSIONS___

[
  {
    "instance": {
      "key": {
        "publicId": "write_data_layer",
        "versionId": "1"
      },
      "param": [
        {
          "key": "keyPatterns",
          "value": {
            "type": 2,
            "listItem": [
              {
                "type": 1,
                "string": "url_passthrough"
              },
              {
                "type": 1,
                "string": "ads_data_redaction"
              }
            ]
          }
        }
      ]
    },
    "clientAnnotations": {
      "isEditedByUser": true
    },
    "isRequired": true
  },
  {
    "instance": {
      "key": {
        "publicId": "access_consent",
        "versionId": "1"
      },
      "param": [
        {
          "key": "consentTypes",
          "value": {
            "type": 2,
            "listItem": [
              {
                "type": 3,
                "mapKey": [
                  {
                    "type": 1,
                    "string": "consentType"
                  },
                  {
                    "type": 1,
                    "string": "read"
                  },
                  {
                    "type": 1,
                    "string": "write"
                  }
                ],
                "mapValue": [
                  {
                    "type": 1,
                    "string": "ad_storage"
                  },
                  {
                    "type": 8,
                    "boolean": true
                  },
                  {
                    "type": 8,
                    "boolean": true
                  }
                ]
              },
              {
                "type": 3,
                "mapKey": [
                  {
                    "type": 1,
                    "string": "consentType"
                  },
                  {
                    "type": 1,
                    "string": "read"
                  },
                  {
                    "type": 1,
                    "string": "write"
                  }
                ],
                "mapValue": [
                  {
                    "type": 1,
                    "string": "analytics_storage"
                  },
                  {
                    "type": 8,
                    "boolean": true
                  },
                  {
                    "type": 8,
                    "boolean": true
                  }
                ]
              },
              {
                "type": 3,
                "mapKey": [
                  {
                    "type": 1,
                    "string": "consentType"
                  },
                  {
                    "type": 1,
                    "string": "read"
                  },
                  {
                    "type": 1,
                    "string": "write"
                  }
                ],
                "mapValue": [
                  {
                    "type": 1,
                    "string": "functionality_storage"
                  },
                  {
                    "type": 8,
                    "boolean": true
                  },
                  {
                    "type": 8,
                    "boolean": true
                  }
                ]
              },
              {
                "type": 3,
                "mapKey": [
                  {
                    "type": 1,
                    "string": "consentType"
                  },
                  {
                    "type": 1,
                    "string": "read"
                  },
                  {
                    "type": 1,
                    "string": "write"
                  }
                ],
                "mapValue": [
                  {
                    "type": 1,
                    "string": "personalization_storage"
                  },
                  {
                    "type": 8,
                    "boolean": true
                  },
                  {
                    "type": 8,
                    "boolean": true
                  }
                ]
              },
              {
                "type": 3,
                "mapKey": [
                  {
                    "type": 1,
                    "string": "consentType"
                  },
                  {
                    "type": 1,
                    "string": "read"
                  },
                  {
                    "type": 1,
                    "string": "write"
                  }
                ],
                "mapValue": [
                  {
                    "type": 1,
                    "string": "security_storage"
                  },
                  {
                    "type": 8,
                    "boolean": true
                  },
                  {
                    "type": 8,
                    "boolean": true
                  }
                ]
              }
            ]
          }
        }
      ]
    },
    "clientAnnotations": {
      "isEditedByUser": true
    },
    "isRequired": true
  },
  {
    "instance": {
      "key": {
        "publicId": "get_cookies",
        "versionId": "1"
      },
      "param": [
        {
          "key": "cookieAccess",
          "value": {
            "type": 1,
            "string": "specific"
          }
        },
        {
          "key": "cookieNames",
          "value": {
            "type": 2,
            "listItem": [
              {
                "type": 1,
                "string": "consentGiven"
              },
              {
                "type": 1,
                "string": "consentAdvanceSetting"
              }
            ]
          }
        }
      ]
    },
    "clientAnnotations": {
      "isEditedByUser": true
    },
    "isRequired": true
  },
  {
    "instance": {
      "key": {
        "publicId": "logging",
        "versionId": "1"
      },
      "param": [
        {
          "key": "environments",
          "value": {
            "type": 1,
            "string": "debug"
          }
        }
      ]
    },
    "isRequired": true
  }
]


___TESTS___

scenarios:
- name: gtag command created
  code: |-
    mock('createArgumentsQueue', (cmd, arr) => {
      assertThat(cmd).isEqualTo('gtag');
      assertThat(arr).isEqualTo('dataLayer');
      return () => {};
    });

    // Call runCode to run the template's code.
    runCode(mockData);

    // Verify that the tag finished successfully.
    assertApi('gtmOnSuccess').wasCalled();
- name: extra settings sent
  code: |-
    mock('gtagSet', (obj) => {
      assertThat(obj.url_passthrough).isEqualTo(true);
      assertThat(obj.ads_data_redaction).isEqualTo(true);
    });
    // Call runCode to run the template's code.
    runCode(mockData);

    // Verify that the tag finished successfully.
    assertApi('gtmOnSuccess').wasCalled();
setup: |-
  const mockData = {
    command: 'default',
    settingsTable: [{
      ad_storage: 'granted',
      analytics_storage: 'denied',
      personalization_storage: 'denied',
      functionality_storage: 'denied',
      security_storage: 'denied'
    },{
      ad_storage: 'denied',
      analytics_storage: 'granted',
      personalization_storage: 'granted',
      functionality_storage: 'granted',
      security_storage: 'granted'
    }],
    url_passthrough: true,
    ads_data_redaction: true
  };


___NOTES___

Created on 11/1/2023, 4:07:42 PM


